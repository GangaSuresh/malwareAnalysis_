package com.example.malwaredetect;

import androidx.annotation.Nullable;
import androidx.appcompat.app.AppCompatActivity;

import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.Toast;

import com.androidnetworking.AndroidNetworking;
import com.androidnetworking.common.Priority;
import com.androidnetworking.error.ANError;
import com.androidnetworking.interfaces.JSONArrayRequestListener;
import com.androidnetworking.interfaces.JSONObjectRequestListener;

import org.json.JSONArray;
import org.json.JSONObject;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.net.URI;
import java.security.MessageDigest;

public class MainActivity extends AppCompatActivity implements AdapterView.OnItemSelectedListener {
    final String xApiToken = "9d33d694124645e5adab01d4d2e284625320350e5008140ac72b234c675f4e0f";
    final String xLinkScanUrl = "https://www.virustotal.com/vtapi/v2/url/scan";
    //get the spinner from the xml.
    String[] items = new String[]{"URL", "FILE"};
    boolean isurl;
    Intent myfileIntent;
    String filepath;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        AndroidNetworking.initialize(getApplicationContext());
        final Button filepicker=findViewById(R.id.filepicker);
        Button scan=findViewById(R.id.button);
        //dropdown
        Spinner spinner = (Spinner)findViewById(R.id.spinner);
        final ArrayAdapter<String>adapter = new ArrayAdapter<String>(MainActivity.this, android.R.layout.simple_spinner_item,items);
        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
        spinner.setAdapter(adapter);
        spinner.setOnItemSelectedListener(this);
        //file picker
        filepicker.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                myfileIntent=new Intent(Intent.ACTION_GET_CONTENT);
                //type of file
                myfileIntent.setType("*/*");
                startActivityForResult(myfileIntent,10);

            }
        });
        //button
        scan.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {
                if(isurl){
                    urlselected();
                }
                else{
                    System.out.println("file");
                    fileselected();
                }
            }
        });
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
        final EditText et = findViewById(R.id.editText2);
        super.onActivityResult(requestCode, resultCode, data);
        switch (requestCode) {
            case 10:
                if (resultCode == RESULT_OK) {
                    filepath = data.getData().toString();
                    System.out.println(data.getData());

                    //Create checksum for this file
                    try {
                        URI uri = new URI(data.getData().toString());
                        File file = new File("//storage//emulated//0//WhatsApp//Media//WhatsApp Documents//GOMSNo.87-NightCurfew.pdf");
                        MessageDigest md5Digest = MessageDigest.getInstance("MD5");
                        //Get the checksum
                        String checksum = getFileChecksum(md5Digest, file);
                        //see checksum
                        System.out.println(checksum);
                        et.setText(checksum);
                    }catch (Exception e){

                        System.out.println(e);}
                    break;
                }
        }
    }

    @Override
    public void onItemSelected(AdapterView<?> parent, View v, int position, long id) {
        final Button filepicker=findViewById(R.id.filepicker);
        final EditText et=findViewById(R.id.editText2);
        switch (position) {
            case 0:
                // url gets selected
                isurl=true;
                filepicker.setVisibility(View.INVISIBLE);
                break;
            case 1:
                // Whatever you want to happen when the second item gets selected
                isurl=false;
                filepicker.setVisibility(View.VISIBLE);
                break;
        }
    }
   //CAEF973033E593C625FB2AA34F7026DC
    @Override
    public void onNothingSelected(AdapterView<?> parent) {
        // TODO Auto-generated method stub
    }
    public void  fileselected(){
        final EditText et=findViewById(R.id.editText2);
        AndroidNetworking.post(
                "https://www.virustotal.com/vtapi/v2/file/report").addBodyParameter("apikey","3f31f8d6c30a8a2730d77f076f5778c6be9526776bcfa98f040958da3f6e4b75")
                .addBodyParameter("resource",et.getText().toString()).setTag("test").setPriority(Priority.HIGH)
                .build().getAsJSONObject(new JSONObjectRequestListener() {
            @Override
            public void onResponse(JSONObject response) {

                System.out.println(response);
                Intent intent = new Intent(MainActivity.this,displayReport.class);
                            intent.putExtra("report", response.toString());
                            startActivity(intent);
            }
            @Override
            public void onError(ANError anError) {
                System.out.println("**************");
                System.out.println(anError);
                Toast toast = Toast.makeText(getApplicationContext(),
                        anError.toString(),
                        Toast.LENGTH_SHORT);
            }
        });


    }
    public void urlselected(){
        final EditText et=findViewById(R.id.editText2);
        AndroidNetworking.post(
                "https://www.virustotal.com/vtapi/v2/url/scan").addBodyParameter("apikey","3f31f8d6c30a8a2730d77f076f5778c6be9526776bcfa98f040958da3f6e4b75")
                .addBodyParameter("url",et.getText().toString()).setTag("test").setPriority(Priority.HIGH)
                .build().getAsJSONObject(new JSONObjectRequestListener() {
            @Override
            public void onResponse(JSONObject response) {

                System.out.println(response);
                Toast toast = Toast.makeText(getApplicationContext(),
                        response.toString(),
                        Toast.LENGTH_SHORT);
                try{
                    AndroidNetworking.post("https://www.virustotal.com/vtapi/v2/url/report").addBodyParameter("apikey","3f31f8d6c30a8a2730d77f076f5778c6be9526776bcfa98f040958da3f6e4b75")
                            .addBodyParameter("resource",response.get("resource").toString()).build().getAsJSONObject(new JSONObjectRequestListener() {
                        @Override
                        public void onResponse(JSONObject response1) {
                            System.out.println("**************");
                            System.out.println(response1);
                            Toast toast = Toast.makeText(getApplicationContext(),
                                    response1.toString(),
                                    Toast.LENGTH_SHORT);

                            Intent intent = new Intent(MainActivity.this,displayReport.class);
                            intent.putExtra("report", response1.toString());
                            startActivity(intent);
                        }

                        @Override
                        public void onError(ANError anError) {
                            System.out.println("eeee");
                            System.out.println(anError);
                            Toast toast = Toast.makeText(getApplicationContext(),
                                    anError.toString(),
                                    Toast.LENGTH_SHORT);
                        }
                    });}
                catch (Exception e){
                    System.out.println("eeeeeeee");
                }
            }
            @Override
            public void onError(ANError anError) {
                System.out.println("**************");
                System.out.println(anError);
                Toast toast = Toast.makeText(getApplicationContext(),
                        anError.toString(),
                        Toast.LENGTH_SHORT);
            }
        });
    }

    private static String getFileChecksum(MessageDigest digest, File file) throws IOException
    {
        //Get file input stream for reading the file content
        FileInputStream fis = new FileInputStream(file);

        //Create byte array to read data in chunks
        byte[] byteArray = new byte[1024];
        int bytesCount = 0;

        //Read file data and update in message digest
        while ((bytesCount = fis.read(byteArray)) != -1) {
            digest.update(byteArray, 0, bytesCount);
        };

        //close the stream; We don't need it now.
        fis.close();

        //Get the hash's bytes
        byte[] bytes = digest.digest();

        //This bytes[] has bytes in decimal format;
        //Convert it to hexadecimal format
        StringBuilder sb = new StringBuilder();
        for(int i=0; i< bytes.length ;i++)
        {
            sb.append(Integer.toString((bytes[i] & 0xff) + 0x100, 16).substring(1));
        }

        //return complete hash
        return sb.toString();
    }
}

